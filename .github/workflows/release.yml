name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶: æ¨é€ v0.1.0 ç­‰ç‰ˆæœ¬ tag
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸åˆ›å»º Release


jobs:
  build-and-release:
    runs-on: windows-2022  # ä½¿ç”¨ VS 2022 ç¯å¢ƒ
    strategy:
      matrix:
        arch: [x64, Win32]  # Win32 = x86
        include:
          - arch: x64
            arch_name: x64
          - arch: Win32
            arch_name: x86
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Configure CMake (${{ matrix.arch_name }})
      run: |
        cmake -B build-${{ matrix.arch_name }} -S . -DCMAKE_BUILD_TYPE=Release -A ${{ matrix.arch }}
    
    - name: Build Release (${{ matrix.arch_name }})
      run: |
        cmake --build build-${{ matrix.arch_name }} --config Release
    
    - name: Install to Distribution Directory (${{ matrix.arch_name }})
      run: |
        cmake --install build-${{ matrix.arch_name }} --prefix ./dist/NeteaseHookSDK-${{ github.ref_name }} --config Release
    
    - name: Upload Artifacts (${{ matrix.arch_name }})
      uses: actions/upload-artifact@v4
      with:
        name: bins-${{ matrix.arch_name }}
        path: dist/
        retention-days: 1

  package-release:
    needs: build-and-release
    runs-on: windows-2022
    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: dist/
    
    - name: Merge Architectures
      run: |
        New-Item -ItemType Directory -Force -Path merged
        # ä½¿ç”¨ -Force å¼ºåˆ¶åˆå¹¶æ–‡ä»¶å¤¹ï¼Œè§£å†³ "already exists" é”™è¯¯
        Copy-Item -Recurse -Force -Path dist/bins-x86/* -Destination merged/
        Copy-Item -Recurse -Force -Path dist/bins-x64/* -Destination merged/
    
    - name: Package Release
      run: |
        cd merged
        Compress-Archive -Path NeteaseHookSDK-${{ github.ref_name }} -DestinationPath ../NeteaseHookSDK-${{ github.ref_name }}-windows-multiarch.zip
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          NeteaseHookSDK-${{ github.ref_name }}-windows-multiarch.zip
        generate_release_notes: true  # è‡ªåŠ¨ç”Ÿæˆå˜æ›´æ—¥å¿— (åŸºäº PR/Commit)
        body: |
          ## NeteaseHookSDK ${{ github.ref_name }}
          
          è¯¦ç»†æ–‡æ¡£ä¸é›†æˆè¯´æ˜è¯·å‚é˜… [README.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/README.md)ã€‚
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          æœ¬ç‰ˆæœ¬åŒæ—¶åŒ…å« **x86** å’Œ **x64** æ¶æ„ã€‚SDK ä¼šè‡ªåŠ¨æ£€æµ‹ç›®æ ‡ç½‘æ˜“äº‘éŸ³ä¹çš„æ¶æ„å¹¶éƒ¨ç½²åŒ¹é…çš„ DLLã€‚
          
          ### âœ¨ v0.1.0 é‡è¦ç‰¹æ€§
          - **æ ¸å¿ƒé©±åŠ¨**: åŸºäº CDP çš„éä¾µå…¥å¼çŠ¶æ€ç›‘å¬ï¼Œè§£å†³ V8 å †éšæœºåŒ–ä¸æŒ‡é’ˆå‹ç¼©é—®é¢˜ã€‚
          - **WebAPI å¢å¼º**: æ”¯æŒæ­Œæ›²å…ƒæ•°æ®è·å–ã€ä¸“è¾‘å°é¢ä¸‹è½½ (stb_image) ä»¥åŠ æ­Œè¯åŒæ­¥ (WinINet)ã€‚
          - **éŸ³é¢‘æ•æ‰**: é›†æˆ WASAPI Loopback (miniaudio) ä¸ FFT å¯è§†åŒ–ã€‚
          - **æ™ºèƒ½ç¼“å­˜**: æ”¯æŒ Cache-Aside æ­Œè¯ç¼“å­˜ç­–ç•¥ã€‚
          - **Demo App**: åŸºäº Raylib å¼€å‘çš„æ²‰æµ¸å¼é»‘èƒ¶å”±æœºç›‘æ§ç¨‹åºã€‚
          
          ### ğŸ›  æ„å»ºä¸ä¿®å¤
          - è§£å†³äº† `NeteaseDriver::Instance()` LNK2019 ç¬¦å·æœªå®šä¹‰é—®é¢˜ã€‚
          - ä¿®å¤äº† AudioCapture æ¨¡å—åœ¨ x64 ç¯å¢ƒä¸‹çš„å›è°ƒä½œç”¨åŸŸå†²çªã€‚
          - å½’æ¡£äº†å…¨é‡è®¾è®¡åŸæ¡ˆè‡³ `Archived/` ç›®å½•ã€‚
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
