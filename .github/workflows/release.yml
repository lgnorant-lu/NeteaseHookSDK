name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶: æ¨é€ v0.0.2 ç­‰ç‰ˆæœ¬ tag
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸åˆ›å»º Release


jobs:
  build-and-release:
    runs-on: windows-2022  # ä½¿ç”¨ VS 2022 ç¯å¢ƒ
    strategy:
      matrix:
        arch: [x64, Win32]  # Win32 = x86
        include:
          - arch: x64
            arch_name: x64
          - arch: Win32
            arch_name: x86
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Configure CMake (${{ matrix.arch_name }})
      run: |
        cmake -B build-${{ matrix.arch_name }} -S . -DCMAKE_BUILD_TYPE=Release -A ${{ matrix.arch }}
    
    - name: Build Release (${{ matrix.arch_name }})
      run: |
        cmake --build build-${{ matrix.arch_name }} --config Release
    
    - name: Install to Distribution Directory (${{ matrix.arch_name }})
      run: |
        cmake --install build-${{ matrix.arch_name }} --prefix ./dist/NeteaseHookSDK-${{ github.ref_name }} --config Release
    
    - name: Upload Artifacts (${{ matrix.arch_name }})
      uses: actions/upload-artifact@v4
      with:
        name: bins-${{ matrix.arch_name }}
        path: dist/
        retention-days: 1

  package-release:
    needs: build-and-release
    runs-on: windows-2022
    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: dist/
    
    - name: Merge Architectures
      run: |
        New-Item -ItemType Directory -Force -Path merged
        Copy-Item -Recurse -Path dist/bins-x86/* -Destination merged/
        Copy-Item -Recurse -Path dist/bins-x64/* -Destination merged/
    
    - name: Package Release
      run: |
        cd merged
        Compress-Archive -Path NeteaseHookSDK-${{ github.ref_name }} -DestinationPath ../NeteaseHookSDK-${{ github.ref_name }}-windows-multiarch.zip
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          NeteaseHookSDK-${{ github.ref_name }}-windows-multiarch.zip
        generate_release_notes: true  # è‡ªåŠ¨ç”Ÿæˆå˜æ›´æ—¥å¿— (åŸºäº PR/Commit)
        body: |
          ## NeteaseHookSDK ${{ github.ref_name }}
          
          è¯¦ç»†æ–‡æ¡£ä¸å®‰è£…æŒ‡å—è¯·å‚é˜… [README.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/README.md)ã€‚
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          æœ¬ç‰ˆæœ¬åŒæ—¶åŒ…å« **x86** å’Œ **x64** æ¶æ„ã€‚SDK ä¼šè‡ªåŠ¨æ£€æµ‹ç›®æ ‡ç½‘æ˜“äº‘éŸ³ä¹çš„æ¶æ„å¹¶éƒ¨ç½²åŒ¹é…çš„ DLLã€‚
          
          ### âœ¨ v0.0.2 æ›´æ–°
          - âœ… æ”¯æŒ 32 ä½ (x86) åº”ç”¨ç¨‹åº
          - âœ… æ™ºèƒ½æ¶æ„æ£€æµ‹ (PE Header åˆ†æ)
          - âœ… æ ‡å‡†åŒ–è°ƒç”¨çº¦å®š (`__cdecl`)
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
