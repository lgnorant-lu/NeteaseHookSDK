name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶: æ¨é€ v0.1.1 ç­‰ç‰ˆæœ¬ tag
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸åˆ›å»º Release


jobs:
  build-and-release:
    runs-on: windows-2022  # ä½¿ç”¨ VS 2022 ç¯å¢ƒ
    strategy:
      matrix:
        arch: [x64, Win32]  # Win32 = x86
        include:
          - arch: x64
            arch_name: x64
          - arch: Win32
            arch_name: x86
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Configure CMake (${{ matrix.arch_name }})
      run: |
        cmake -B build-${{ matrix.arch_name }} -S . -DCMAKE_BUILD_TYPE=Release -A ${{ matrix.arch }}
    
    - name: Build Release (${{ matrix.arch_name }})
      run: |
        cmake --build build-${{ matrix.arch_name }} --config Release
    
    - name: Install to Distribution Directory (${{ matrix.arch_name }})
      run: |
        cmake --install build-${{ matrix.arch_name }} --prefix ./dist/NeteaseHookSDK-${{ github.ref_name }} --config Release
    
    - name: Upload Artifacts (${{ matrix.arch_name }})
      uses: actions/upload-artifact@v4
      with:
        name: bins-${{ matrix.arch_name }}
        path: dist/
        retention-days: 1

  package-release:
    needs: build-and-release
    runs-on: windows-2022
    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: dist/
    
    - name: Merge Architectures
      run: |
        New-Item -ItemType Directory -Force -Path merged
        # ä½¿ç”¨ -Force å¼ºåˆ¶åˆå¹¶æ–‡ä»¶å¤¹ï¼Œè§£å†³ "already exists" é”™è¯¯
        Copy-Item -Recurse -Force -Path dist/bins-x86/* -Destination merged/
        Copy-Item -Recurse -Force -Path dist/bins-x64/* -Destination merged/
    
    - name: Package Release
      run: |
        cd merged
        Compress-Archive -Path NeteaseHookSDK-${{ github.ref_name }} -DestinationPath ../NeteaseHookSDK-${{ github.ref_name }}-windows-multiarch.zip
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          NeteaseHookSDK-${{ github.ref_name }}-windows-multiarch.zip
        generate_release_notes: true  # è‡ªåŠ¨ç”Ÿæˆå˜æ›´æ—¥å¿— (åŸºäº PR/Commit)
        body: |
          ## ğŸš€ NeteaseHookSDK ${{ github.ref_name }} (Integration Beta)
          
          æœ¬é¡¹ç›®æ˜¯é’ˆå¯¹ç½‘æ˜“äº‘éŸ³ä¹ (Netease Cloud Music) æ¡Œé¢å®¢æˆ·ç«¯çš„è¿›ç¨‹åº¦ç›‘æ§ä¸æ•°æ®æ•è·è§£å†³æ–¹æ¡ˆã€‚v0.1.0 æ ‡å¿—ç€ä»å•çº¯çš„ CDP ç›‘å¬æ¼”è¿›ä¸º **"çŠ¶æ€ç›‘å¬ + æ•°æ®è¡¥å…¨"** çš„æ··åˆæ¶æ„ã€‚
          
          ### ï¿½ é€†å‘ä¸æ ¸å¿ƒçªç ´ (RE Highlights)
          - **éä¾µå…¥å¼é©»ç•™**: åˆ©ç”¨ Windows PE åŠ è½½ç‰¹æ€§å®ç° `version.dll` åŠ«æŒï¼Œå®Œç¾é¿å¼€ V8 å¼•æ“åº•å±‚æŒ‡é’ˆå‹ç¼©å¯¼è‡´çš„å†…å­˜æ‰«æå¤±æ•ˆã€‚
          - **CDP æ¡¥æ¥æŠ€æœ¯**: åŠ¨æ€æ³¨å…¥ JS Payload è‡³æ¸²æŸ“å±‚ï¼Œå®æ—¶æ•è· `audioplayer.onPlayProgress` äº‹ä»¶ï¼Œå®ç°æ¯«ç§’çº§åŒæ­¥ã€‚
          - **PE æ¶æ„è‡ªé€‚åº”**: é©±åŠ¨å±‚æ”¯æŒ x86/x64 åŒæ¶æ„è‡ªé€‚åº”æ¢æµ‹ï¼Œç¡®ä¿åœ¨ä¸åŒç¯å¢ƒä¸‹çš„ç¨³å®šæ€§ã€‚
          
          ### âœ¨ WebAPI & å¢å¼ºåŠŸèƒ½
          - **æ™ºèƒ½æ­Œè¯ç³»ç»Ÿ**: å®ç° Cache-Aside ç¼“å­˜ç­–ç•¥ï¼Œå…¼å®¹å®˜æ–¹åŠ å¯†æ ¼å¼ï¼Œæ”¯æŒ LRC/ç¿»è¯‘/ç½—é©¬éŸ³åŒæ­¥ã€‚
          - **åª’ä½“ä¿¡æ¯æå–**: åŸºäº `WinINet` å®ç°è½»é‡çº§å…ƒæ•°æ®è·å–ä¸ä¸“è¾‘å°é¢ä¸‹è½½ï¼ˆç”± `stb_image` é©±åŠ¨ï¼‰ã€‚
          - **éŸ³é¢‘é£æš´å¯è§†åŒ–**: é›†æˆ WASAPI ç¯å½¢æ•æ‰ï¼Œå®æ—¶ FFT é¢‘è°±åˆ†æã€‚
          
          ### ğŸ¨ Demo åº”ç”¨æ›´æ–° (NeteaseMonitor)
          - **æ²‰æµ¸å¼é»‘èƒ¶æ¸²æŸ“**: ç»è¿‡å¾®è°ƒçš„ **1.2 RPM** ææ…¢æ—‹è½¬æ„Ÿï¼Œå®Œç¾è¿˜åŸç½‘æ˜“äº‘æ²‰æµ¸å¼æ’­æ”¾ä½“éªŒã€‚
          - **å¯è§†åŒ–è¿›é˜¶**: å¼•å…¥æµä½“ä¸çº¿ä¸ç²’å­ç³»ç»Ÿï¼Œæ”¯æŒæå…‰èƒŒæ™¯ä¸ç»ç’ƒæ‹Ÿæ€ Shader æ¸²æŸ“ã€‚
          - **ç‰©ç†åŠ¨æ•ˆ**: å¢åŠ å”±é’ˆï¼ˆTonearmï¼‰å¹³æ»‘å‡é™ç‰©ç†æ¨¡æ‹Ÿã€‚
          
          ### ğŸ“¦ Release åŒ…ä½¿ç”¨è¯´æ˜
          
          **å¿«é€Ÿä¸Šæ‰‹**ï¼š
          1. è§£å‹ zip æ–‡ä»¶
          2. è¿›å…¥ `bin/x64` (æˆ– `bin/x86`) ç›®å½•
          3. ç›´æ¥è¿è¡Œ `NeteaseMonitor.exe`
          4. é¦–æ¬¡ä½¿ç”¨æŒ‰ `Ctrl + I` å®‰è£… Hookï¼Œç¨‹åºå°†è‡ªåŠ¨é‡å¯ç½‘æ˜“äº‘éŸ³ä¹
          
          **ç³»ç»Ÿè¦æ±‚**ï¼š
          - Windows 7 / 8 / 10 / 11 (x86 æˆ– x64)
          - [VC++ 2015-2022 Redistributable](https://aka.ms/vs/17/release/vc_redist.x64.exe)
          - ç½‘æ˜“äº‘éŸ³ä¹å®¢æˆ·ç«¯
          
          **å¸¸è§é—®é¢˜**ï¼š
          - å¯åŠ¨æŠ¥é”™ "æ‰¾ä¸åˆ° MSVCP140.dll" â†’ å®‰è£… VC++ è¿è¡Œåº“
          - æ­Œè¯æ˜¾ç¤ºä¹±ç  â†’ ç¡®è®¤ç³»ç»Ÿå·²å®‰è£…ä¸­æ–‡å­—ä½“ï¼ˆé»‘ä½“/å¾®è½¯é›…é»‘ï¼‰
          - æ— æ³•è¿æ¥ â†’ ç¡®è®¤å·²æŒ‰ `Ctrl + I` å®‰è£… Hook å¹¶é‡å¯ç½‘æ˜“äº‘
          
          ### ğŸ›  æ„å»ºä¿®å¤ä¸å®¡è®¡
          - ä¿®å¤ `NeteaseDriver::Instance()` ç¬¦å·ä¸¢å¤±å¯¼è‡´çš„ LNK2019 é“¾æ¥é”™è¯¯ã€‚
          - è§£å†³äº† x64 ç¯å¢ƒä¸‹ `AudioCapture` å›è°ƒå‡½æ•°çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†å†²çªã€‚
          - å½’æ¡£äº† v0.1.0 çš„å…¨é‡è®¾è®¡åŸæ¡ˆè‡³ `Archived/` ç›®å½•ã€‚
          
          ---
          è¯¦ç»†æ–‡æ¡£è¯·å‚é˜… [README.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/README.md)ã€‚
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
