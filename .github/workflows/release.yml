name: Release Build

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶: æ¨é€ v0.0.1 ç­‰ç‰ˆæœ¬ tag
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸åˆ›å»º Release


jobs:
  build-and-release:
    runs-on: windows-2022  # ä½¿ç”¨ VS 2022 ç¯å¢ƒ
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Configure CMake
      run: |
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release -A x64
    
    - name: Build Release
      run: |
        cmake --build build --config Release
    
    - name: Install to Distribution Directory
      run: |
        cmake --install build --prefix ./dist/NeteaseHookSDK-${{ github.ref_name }} --config Release
    
    - name: Package Release
      run: |
        cd dist
        Compress-Archive -Path NeteaseHookSDK-${{ github.ref_name }} -DestinationPath NeteaseHookSDK-${{ github.ref_name }}-windows-x64.zip
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          dist/NeteaseHookSDK-${{ github.ref_name }}-windows-x64.zip
        generate_release_notes: true  # è‡ªåŠ¨ç”Ÿæˆå˜æ›´æ—¥å¿— (åŸºäº PR/Commit)
        body: |
          ## NeteaseHookSDK ${{ github.ref_name }}
          
          è¯¦ç»†æ–‡æ¡£ä¸å®‰è£…æŒ‡å—è¯·å‚é˜… [README.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/README.md)ã€‚
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          è¯·ä¸‹è½½ä¸‹æ–¹çš„ `NeteaseHookSDK-*-windows-x64.zip`ï¼Œè§£å‹å³å¯ä½¿ç”¨ã€‚
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
